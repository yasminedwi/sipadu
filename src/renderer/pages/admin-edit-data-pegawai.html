<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIPADU - Edit Data Pegawai</title>
  <link rel="stylesheet" href="../css/style.css">
</head>

<body class="dashboard-page1">

  <header class="top-bar2" id="topbar">
    <a href="all-read-dashboard.html">
        <img src="../css/images/logo-dpmptsp-v-footer.png"
            class="logo-mini"
            alt="Logo DPMPTSP">
    </a>
    <img src="../css/images/Lambang_Kota_Kendari.png"
         class="logo-kota" alt="Logo Kota Kendari">

    <h2>EDIT DATA PEGAWAI</h2>
  </header>

    <main class="content4">
      
    <!-- IMPORTANT PART -->
    <form id="pegawaiForm">
      <div class="form-grid">

        <!-- KIRI -->
        <div>
          <label>Nama</label>
          <input type="text" name="nama" id="nama" required>

          <label>NIP</label>
          <input type="text" name="nip" id="nip" required>

          <label>Tempat Lahir</label>
          <input type="text" name="tempat_lahir" id="tempat_lahir" required>

          <label>Tanggal Lahir</label>
          <input type="date" name="tanggal_lahir" id="tanggal_lahir" required>

          <label>Golongan</label>
          <select name="golongan"  id="golongan" required>
            <option value="">-- Pilih Golongan --</option>
            <option value="I/a">I/a</option>
            <option value="I/b">I/b</option>
            <option value="I/c">I/c</option>
            <option value="I/d">I/d</option>
            <option value="II/a">II/a</option>
            <option value="II/b">II/b</option>
            <option value="II/c">II/c</option>
            <option value="II/d">II/d</option>
            <option value="III/a">III/a</option>
            <option value="III/b">III/b</option>
            <option value="III/c">III/c</option>
            <option value="III/d">III/d</option>
            <option value="IV/a">IV/a</option>
            <option value="IV/b">IV/b</option>
            <option value="IV/c">IV/c</option>
            <option value="IV/d">IV/d</option>
            <option value="IV/e">IV/e</option>
          </select>

          <label>TMT Golongan</label>
          <input type="date" name="tmt_golongan" id="tmt_golongan" required>

          <label>Jabatan</label>
          <input type="text" name="jabatan" id="jabatan" required>

          <label>TMT Jabatan</label>
          <input type="date" name="tmt_jabatan" id="tmt_jabatan" required>
        </div>

        <!-- KANAN -->
        <div>
          <label>Jenis Kelamin</label>
          <select name="jenis_kelamin" id="jenis_kelamin" required>
            <option value="">-- Pilih Jenis Kelamin --</option>
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>

          <label>Masa Kerja (berakhir)</label>
          <input type="date" name="masa_kerja" id="masa_kerja">

          <label>Diklat Penunjang</label>
          <input type="text" name="diklat" id="diklat">

          <label>Ijazah Terakhir</label>
          <input type="text" name="ijazah" id="ijazah">

          <label>Password</label>
          <input type="password" name="password" id="password">

          <label>Role</label>
          <select name="role" id="role" required>
            <option value="">-- Pilih Role --</option>
            <option value="admin">Admin</option>
            <option value="pegawai">Reguler</option>
          </select>
        </div>

      </div>

      <div class="akun-button">
        <button type="submit" class="btn-simpan">SIMPAN</button>

        <button type="button" class="btn-urungkan"
          onclick="window.location.href='admin-page.html'">
          URUNGKAN
        </button>

        <button type="button" class="btn-hapus">
          HAPUS
        </button>

        <button type="button" class="btn-keluarga" onclick="window.location.href='admin-read-data-keluarga-pegawai.html'">
          EDIT KELUARGA
        </button>
      </div>
    </form>
  </div>

  <script>
    const { ipcRenderer } = require("electron");

    document.addEventListener("DOMContentLoaded", async () => {
      let originalNip = null;

      // Ambil NIP dari query param
      const params = new URLSearchParams(window.location.search);
      originalNip = params.get("nip");
      if (!originalNip) {
        alert("NIP tidak ditemukan!");
        return;
      }

      // ðŸ”¥ Ambil data user
      const response = await ipcRenderer.invoke("get-user", originalNip);
      if (!response.success || !response.user) {
        alert("Data pegawai tidak ditemukan!");
        return;
      }

      const user = response.user;

      // ðŸ”¥ Isi form dengan data lama
      document.getElementById("nama").value = user.nama || "";
      document.getElementById("nip").value = user.nip || "";
      document.getElementById("tempat_lahir").value = user.tempat_lahir || "";
      document.getElementById("tanggal_lahir").value = user.tanggal_lahir || "";
      document.getElementById("golongan").value = user.golongan || "";
      document.getElementById("tmt_golongan").value = user.tmt_golongan || "";
      document.getElementById("jabatan").value = user.jabatan || "";
      document.getElementById("tmt_jabatan").value = user.tmt_jabatan || "";
      document.getElementById("jenis_kelamin").value = user.jenis_kelamin || "";
      document.getElementById("masa_kerja").value = user.masa_kerja || "";
      document.getElementById("diklat").value = user.diklat || "";
      document.getElementById("ijazah").value = user.ijazah || "";
      document.getElementById("role").value = user.role || "";

      // ðŸ”¥ HANDLE UPDATE FORM
      const form = document.getElementById("pegawaiForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(form).entries());

        const result = await ipcRenderer.invoke("update-user", {
          oldNip: originalNip,
          ...formData
        });

        if (result.success) {
          alert("Data berhasil diupdate!");
          window.location.href = "admin-page.html";
        } else {
          alert("Gagal update data!");
        }
      });

      // ðŸ”¥ HANDLE HAPUS BUTTON
      const btnHapus = document.querySelector(".btn-hapus");
      btnHapus.addEventListener("click", async () => {
        const confirmed = confirm("Apakah Anda yakin ingin menghapus data ini?");
        if (!confirmed) return;

        const result = await ipcRenderer.invoke("delete-user", originalNip);
        if (result.success) {
          alert("Data berhasil dihapus!");
          window.location.href = "admin-page.html";
        } else {
          alert("Gagal menghapus data: " + (result.error || ""));
        }
      });

      // ðŸ”¥ HANDLE EDIT KELUARGA BUTTON
      const btnKeluarga = document.querySelector(".btn-keluarga");
      btnKeluarga.addEventListener("click", () => {
        window.location.href = `admin-read-data-keluarga-pegawai.html?nip=${originalNip}`;
      });

    });
  </script>
</body>
</html>
