<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Akun</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body class="dashboard-page">

    <header class="top-bar" id="topBar">

        <!-- ADMIN AREA -->
        <div id="adminArea">
        <button class="admin-btn"
            onclick="window.location.href='admin-page.html'">
            ADMIN
        </button>
        </div>

    <a href="all-read-dashboard.html">
        <img src="../css/images/logo-dpmptsp-v-footer.png"
            class="logo-mini"
            alt="Logo DPMPTSP">
    </a>
    <img src="../css/images/Lambang_Kota_Kendari.png"
         class="logo-kota" alt="Logo Kota Kendari">

        <nav>
            <button class="nav-btn" style="top: -13px;"
                onclick="window.location.href='all-read-dashboard.html'">
                BERANDA
            </button>

            <button class="nav-btn1 active" style="top: -2px;"
                onclick="window.location.href='all-edit-pengaturan-akun.html'">
                AKUN
            </button>

            <button class="nav-btn2" style="top: -14px;"
                onclick="window.location.href='all-konfirmasi-logout.html'">
                KELUAR
            </button>
        </nav>
    </header>

    <!-- CONTENT LAYERS -->
    <div class="content1"></div>
    <div class="content2"></div>
    <div class="content3"></div>
    
<main class="content">
    <div class="akun-wrapper">
        <div class="akun-left">
            <p>Foto Profil</p>
            <div class="foto-profil">
                <img id="previewFoto" width="120" height="120" style="object-fit: cover;">
                <input type="file" id="profilePic" accept="image/*">
            </div>
        </div>

        <div class="akun-divider"></div>

        <div class="akun-right">
            <!-- FORM MULAI DI SINI -->
            <form id="editForm">

                <label>Nama Lengkap</label>
                <input type="text" id="nama">

                <label>NIP</label>
                <input type="text" id="nip">

                <label>Password Baru</label>
                <input type="password" id="password" placeholder="Kosongkan jika tidak diubah">

                <div class="akun-button">
                    <button class="btn-batal" type="reset">Batal</button>
                    <button class="btn-simpan" type="submit">Simpan</button>
                </div>

            </form>
            <!-- FORM SELESAI DI SINI -->

        </div>
    </div>
</main>
      <!-- ROLE CHECK -->
    <script>
    const { ipcRenderer } = require("electron");

    const loginUser = JSON.parse(localStorage.getItem("loginUser"));

    if (!loginUser) {
        window.location.href = "index.html";
    }

    const form = document.getElementById("editForm");
    const adminArea = document.getElementById("adminArea");
    const topBar = document.getElementById("topBar");
    const previewFoto = document.getElementById("previewFoto");
    const fileInput = document.getElementById("profilePic");

    if (loginUser.role !== "admin") {
        adminArea.style.display = "none";
    } else {
        topBar.classList.add("admin-top-bar");
    }

    // ==========================
    // LOAD USER
    // ==========================
    async function loadUser() {
        const result = await ipcRenderer.invoke("get-user", loginUser.nip);
        if (!result.success) return;

        document.getElementById("nama").value = result.user.nama;
        document.getElementById("nip").value = result.user.nip;

        if (result.user.foto) {
            const base64 = await ipcRenderer.invoke(
                "get-photo-base64",
                result.user.foto
            );

            previewFoto.src = base64 || "";
        } else {
            previewFoto.src = "";
        }
    }

    loadUser();

    // ==========================
    // PREVIEW FOTO (FIXED)
    // ==========================
    fileInput.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const imageURL = URL.createObjectURL(file);
        previewFoto.src = imageURL;
    });

    // ==========================
    // SAVE UPDATE
    // ==========================
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = fileInput.files[0];
        let fileBuffer = null;
        let fileName = null;

        if (file) {
            fileBuffer = await file.arrayBuffer();
            fileName = file.name;
        }

        const result = await ipcRenderer.invoke("update-user", {
            oldNip: loginUser.nip,
            newNip: document.getElementById("nip").value,
            nama: document.getElementById("nama").value,
            password: document.getElementById("password").value,
            fileBuffer: fileBuffer,
            fileName: fileName
        });

        if (result.success) {
            alert("Akun berhasil diupdate!");

            loginUser.nip = document.getElementById("nip").value;
            localStorage.setItem("loginUser", JSON.stringify(loginUser));

            loadUser();
        } else {
            alert("Gagal update akun!");
        }
    });
    </script>

</body>
</html>